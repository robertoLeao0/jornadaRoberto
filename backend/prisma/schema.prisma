generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN_PLENO
  GESTOR_MUNICIPIO
  SERVIDOR
}

enum ActionStatus {
  PENDENTE
  CONCLUIDO
}

enum DayCategory {
  CORPO
  MENTE
  ESPIRITO
}

model User {
  id                     String    @id @default(uuid())
  name                   String
  email                  String    @unique
  passwordHash           String
  role                   UserRole
  municipalityId         String?
  municipality           Municipality? @relation(fields: [municipalityId], references: [id])
  actionLogs             ActionLog[]
  ranking                RankingSummary[]
  deletedAt              DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  // New fields for integrations
  phone                  String?   @unique
  manychatSubscriberId   String?   @unique
}


model Municipality {
  id        String   @id @default(uuid())
  name      String
  state     String
  active    Boolean  @default(true)
  projects  Project[]
  users     User[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Project {
  id            String        @id @default(uuid())
  name          String
  description   String
  startDate     DateTime
  endDate       DateTime
  municipalityId String
  municipality  Municipality  @relation(fields: [municipalityId], references: [id])
  isActive      Boolean       @default(true)
  totalDays     Int           @default(21)
  dayTemplates  DayTemplate[]
  actionLogs    ActionLog[]
  ranking       RankingSummary[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}


model Task {
  id           Int      @id @default(autoincrement())
  nome         String
  descricao    String?  // O ? significa opcional
  dataPrevista DateTime
  ativo        Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("tasks") // Nome da tabela no banco
}


model IntegrationSetting {
  id             String   @id @default(uuid())
  name           String
  projectId      String?
  enabled        Boolean  @default(false)
  webhookSecret  String?
  apiKey         String?
  configJson     Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([name, projectId])
}

model ManychatConnection {
  id               String   @id @default(uuid())
  projectId        String?
  provider         String   @default("manychat")
  connected        Boolean  @default(false)
  accessToken      String?
  refreshToken     String?
  subscriberCount  Int?     @default(0)
  lastSyncAt       DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([provider, projectId])
}

model ScheduledMessage {
  id           String   @id @default(uuid())
  projectId    String?
  title        String
  body         String
  mediaUrl     String?
  targetType   String
  targetValue  String?
  scheduledAt  DateTime
  repeatCron   String?
  status       String   @default("scheduled")
  lastResult   Json?
  createdBy    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}




model DayTemplate {
  id          String      @id @default(uuid())
  projectId   String
  project     Project     @relation(fields: [projectId], references: [id])
  dayNumber   Int
  title       String
  description String
  category    DayCategory
  points      Int          @default(1)
  requiresPhoto Boolean    @default(false)

  @@unique([projectId, dayNumber], name: "projectId_dayNumber")
}

model ActionLog {
  id          String       @id @default(uuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  projectId   String
  project     Project      @relation(fields: [projectId], references: [id])
  dayNumber   Int
  status      ActionStatus @default(PENDENTE)
  photoUrl    String?
  notes       String?
  completedAt DateTime?
  pointsAwarded Int        @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([userId, projectId, dayNumber], name: "userId_projectId_dayNumber")
}

model RankingSummary {
  userId         String
  projectId      String
  totalPoints    Int
  completedDays  Int
  completionRate Float
  user           User    @relation(fields: [userId], references: [id])
  project        Project @relation(fields: [projectId], references: [id])

  @@id([userId, projectId])
}
